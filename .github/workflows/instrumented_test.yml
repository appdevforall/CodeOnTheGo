name: Instrumented Tests
permissions:
  contents: write
  actions: write
on:
  push:
    branches: [ "stage", "feature/**" ]
  pull_request:
    branches: [ "stage", "feature/**" ]
  workflow_dispatch: { }

env:
  BUILD_JAVA_VERSION: '17'
  BUILD_JAVA_DIST: 'temurin'

jobs:
  run_instrumented_tests:
    name: Run Instrumented Tests
    runs-on: self-hosted
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - name: Setup Git LFS
        run: |
          echo Setting up Git LFS
          where git-lfs || (
            echo Installing Git LFS
            powershell -Command "Invoke-WebRequest -Uri https://github.com/git-lfs/git-lfs/releases/download/v3.4.1/git-lfs-windows-amd64-v3.4.1.zip -OutFile git-lfs.zip; Expand-Archive -Path git-lfs.zip -DestinationPath git-lfs; cd git-lfs; .\git-lfs-3.4.1\install.bat"
          )
          git lfs install
        shell: cmd

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Pull Git LFS Files
        run: git lfs pull
        shell: cmd

      - name: Initialize Submodules
        run: |
          git submodule init
          git submodule update --remote
        shell: cmd

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.BUILD_JAVA_VERSION }}
          distribution: ${{ env.BUILD_JAVA_DIST }}

      - name: Restore Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Create AVD
        run: |
          echo no | avdmanager.bat create avd -n test_avd -k "system-images;android-30;google_apis;x86_64" --force
        shell: cmd

      - name: Start Android Emulator
        run: |
          start /b emulator.bat -avd test_avd -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect
          powershell -Command "& {
            $startTime = Get-Date;
            while (!(adb shell getprop sys.boot_completed 2>&1 | Select-String '1')) {
              if ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalSeconds -gt 300) {
                Write-Host 'Emulator boot timed out'; exit 1
              }
              Start-Sleep -Seconds 5;
              Write-Host 'Waiting for emulator to boot...'
            }
          }"
        shell: cmd

      - name: Run Instrumented Tests
        run: |
          adb devices
          gradlew.bat app:cAT "-Pandroid.testInstrumentationRunnerArguments.class=com.itsaky.androidide.OrderedTestSuite" --stacktrace
        shell: cmd
        env:
          ANDROIDIDE_TEST: true

      - name: Upload Test Reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-results-instrumented
          path: '**/build/reports/tests/'
